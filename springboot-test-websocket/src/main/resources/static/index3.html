<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>websocket通讯-用户20</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://raw.githubusercontent.com/jmesnil/stomp-websocket/master/lib/stomp.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
</head>
<body>
<div><a href="javascript:void(0)" onclick="openSocket()">开启聊天</a></div>
<div id="chatDiv" style="background-color: gainsboro;width: 50%">

</div>

<div><input id="contentText" name="contentText" type="text" value="hello zhangsan">
    <a href="javascript:void(0)" onclick="sendMessage()">发送</a></div>

<script>
    /**
     * 利用stomp和socketjs
     */
    let stompClient = null;

    function openSocket() {
        if (typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            let wsUrl = "http://localhost:8080/ws/audit";
            // 建立连接对象（还未发起连接）
            let socket = new SockJS(wsUrl);
            // 获取 STOMP 子协议的客户端对象
            stompClient = Stomp.over(socket);
            var headers = {
                token: 'AABB'
            };
            stompClient.connect(headers, function () {
                console.info("连接成功");
                stompClient.subscribe("queue/test", function (data) {
                    console.info("接收消息：" + data);
                });
            }, function () {
                console.info("连接失败");
                openSocket();// 重新连接
            });
        }
    }

    function sendMessage() {
        if (typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            console.log("您的浏览器支持WebSocket");
            console.log('{"to":"zhangsan","topic":"topic_1","content":"' + $("#contentText").val() + '"}');
            socket.send('{"to":"zhangsan","topic":"topic_1","content":"' + $("#contentText").val() + '"}');
            let p = $("<p style='text-align: right;width: 100%'>我：" + $("#contentText").val() + "</p>");
            $("#chatDiv").append(p);

            stompClient.send(url, {"token": "BBCC"}, {"name": "zhangsan"});
        }
    }
</script>
</body>
</html>